<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calculator Frontend</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 400px; margin: auto; }
        input, select, button { margin: 8px 0; width: 100%; padding: 8px; }
        .result { margin-top: 20px; font-weight: bold; word-break: break-all; white-space: pre-wrap; }
        .error { color: red; }
        .operand-field { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Calculator</h2>
        <form id="calcForm">
            <label for="operation">Operation:</label>
            <select id="operation" name="operation"></select>
            <div id="operands"></div>
            <button type="submit">Calculate</button>
        </form>
        <div class="result" id="result"></div>
    </div>
    <script>
        const form = document.getElementById('calcForm');
        const operationSelect = document.getElementById('operation');
        const operandsDiv = document.getElementById('operands');
        const resultDiv = document.getElementById('result');
        let operations = {};

        // Fetch available operations and operand counts
        async function loadOperations() {
            try {
                const res = await fetch('http://localhost:4567/operations', { method: 'POST' });
                operations = await res.json();
                console.log(operations);
                operationSelect.innerHTML = '';
                Object.entries(operations).forEach(([op, count]) => {
                    const option = document.createElement('option');
                    option.value = op;
                    option.textContent = `${op} (${count} operand${count > 1 ? 's' : ''})`;
                    operationSelect.appendChild(option);
                });
                updateOperandFields();
            } catch (err) {
                resultDiv.textContent = 'Could not load operations from backend.';
            }
        }

        // Show correct number of operand fields
        function updateOperandFields() {
            operandsDiv.innerHTML = '';
            const op = operationSelect.value;
            const count = operations[op];
            for (let i = 0; i < count; i++) {
                const label = document.createElement('label');
                label.htmlFor = `operand${i}`;
                label.textContent = `Operand ${i + 1}:`;
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `operand${i}`;
                input.name = `operand${i}`;
                input.step = 'any';
                input.required = true;
                input.className = 'operand-field';
                operandsDiv.appendChild(label);
                operandsDiv.appendChild(input);
            }
        }

        operationSelect.addEventListener('change', updateOperandFields);

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const op = operationSelect.value;
            const count = operations[op];
            let operands = [];
            for (let i = 0; i < count; i++) {
                const val = document.getElementById(`operand${i}`).value;
                operands.push(parseFloat(val));
            }
            const payload = {
                operandCount: count,
                operands: operands
            };
            const url = `http://localhost:4567/${op}`;
            resultDiv.textContent = 'Calculating...';
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.error) {
                    resultDiv.textContent = `Error: ${data.error}`;
                } else {
                    resultDiv.textContent = `Result: ${data.result}`;
                }
            } catch (err) {
                resultDiv.textContent = `Could not connect to backend.`;
            }
        });

        // Initial load
        loadOperations();
    </script>
</body>
</html>
